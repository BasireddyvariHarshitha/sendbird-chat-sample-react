import{_ as t}from"../bundle/bundle.shared.js";const e={encrypt:t=>t,decrypt:t=>t},i={};class s{constructor({dbname:t,itemSizeLimit:e=1048576,cacheLimit:s=256,blockHashBase:n=2,blockHashMultiplier:o=10,blockHashConstant:r=11,transactionApplyDelay:a=200,disableLogger:c=!1}){return i[t]||(this.itemSizeLimit=e,this.cacheLimit=s,this.blockHashBase=n,this.blockHashMultiplier=o,this.blockHashConstant=r,this.transactionApplyDelay=a,this.disableLogger=c,i[t]=this),i[t]}static get(t){return i[t]}}var n,o;!function(t){t[t.UNKNOWN_ERROR=6e7]="UNKNOWN_ERROR",t[t.STORE_NOT_DEFINED=61001e3]="STORE_NOT_DEFINED",t[t.STORE_NOT_AVAILABLE=61001001]="STORE_NOT_AVAILABLE",t[t.STORE_NOT_AVAILABLE_IN_PRIVATE_BROWSING=61001002]="STORE_NOT_AVAILABLE_IN_PRIVATE_BROWSING",t[t.STORE_IS_FULL=61001003]="STORE_IS_FULL",t[t.STORE_INVALID_KEY_TYPE=61002e3]="STORE_INVALID_KEY_TYPE",t[t.STORE_BROKEN_INTEGRITY=61002001]="STORE_BROKEN_INTEGRITY",t[t.STORE_BROKEN_BLOB=61002002]="STORE_BROKEN_BLOB",t[t.STORE_ITEM_SIZE_LIMIT_EXCEEDED=61017e3]="STORE_ITEM_SIZE_LIMIT_EXCEEDED",t[t.STORE_READ_FAILED=61017001]="STORE_READ_FAILED",t[t.STORE_WRITE_FAILED=61017002]="STORE_WRITE_FAILED",t[t.DATABASE_SCHEMA_NOT_ON_UPGRADE=62002e3]="DATABASE_SCHEMA_NOT_ON_UPGRADE",t[t.COLLECTION_NOT_READY=63001e3]="COLLECTION_NOT_READY",t[t.COLLECTION_KEY_NOT_MATCH=63002e3]="COLLECTION_KEY_NOT_MATCH",t[t.COLLECTION_QUERY_NOT_VALID=63002001]="COLLECTION_QUERY_NOT_VALID",t[t.COLLECTION_KEY_NOT_FOUND=63004e3]="COLLECTION_KEY_NOT_FOUND",t[t.COLLECTION_KEY_NOT_GIVEN=63004001]="COLLECTION_KEY_NOT_GIVEN",t[t.COLLECTION_INSERT_DUPLICATE=63009e3]="COLLECTION_INSERT_DUPLICATE",t[t.COLLECTION_WRITE_FAILED=63017e3]="COLLECTION_WRITE_FAILED",t[t.COLLECTION_ITEM_SIZE_LIMIT_EXCEEDED=63017001]="COLLECTION_ITEM_SIZE_LIMIT_EXCEEDED",t[t.INDEX_TABLE_IS_REQUIRED=65001e3]="INDEX_TABLE_IS_REQUIRED",t[t.INDEX_TYPE_NOT_MATCH=65002e3]="INDEX_TYPE_NOT_MATCH",t[t.COMPARE_TYPE_NOT_MATCH=69002001]="COMPARE_TYPE_NOT_MATCH",t[t.CIRCULAR_REFERENCE_FOUND=69002002]="CIRCULAR_REFERENCE_FOUND"}(n||(n={}));class r extends Error{constructor({code:t=n.UNKNOWN_ERROR,message:e="Unknown error occurred."}){super(e),this.code=t}static get storeNotDefined(){return new r({code:n.STORE_NOT_DEFINED,message:"Store is not defined. Specify the store on NestDB()"})}static get storeNotAvailable(){return new r({code:n.STORE_NOT_AVAILABLE,message:"Store is not available. Check your environment settings."})}static get storeNotAvailableInPrivateBrowsing(){return new r({code:n.STORE_NOT_AVAILABLE_IN_PRIVATE_BROWSING,message:"Store is not available because it is in private browsing."})}static get storeIsFull(){return new r({code:n.STORE_IS_FULL,message:"Store is full."})}static get storeKeyTypeIsInvalid(){return new r({code:n.STORE_INVALID_KEY_TYPE,message:"Store key should be string type."})}static get storeBrokenIntegrity(){return new r({code:n.STORE_BROKEN_INTEGRITY,message:"Data should be in a store but it does not. Integrity is broken."})}static get storeBrokenBlob(){return new r({code:n.STORE_BROKEN_BLOB,message:"Data should be in a store but it does not. Blob data is broken."})}static get storeItemSizeExceeded(){return new r({code:n.STORE_ITEM_SIZE_LIMIT_EXCEEDED,message:"The size of the item exceeds the limit that the store allows."})}static get storeReadFailed(){return new r({code:n.STORE_READ_FAILED,message:"Failed to read from store."})}static get storeWriteFailed(){return new r({code:n.STORE_WRITE_FAILED,message:"Failed to write to store."})}static get databaseSchemaNotOnUpgrade(){return new r({code:n.DATABASE_SCHEMA_NOT_ON_UPGRADE,message:"Committing schema is not allowed when upgrade is not running."})}static get collectionNotReady(){return new r({code:n.COLLECTION_NOT_READY,message:"Collection is not ready due to an error during initialization."})}static get collectionKeyNotMatch(){return new r({code:n.COLLECTION_KEY_NOT_MATCH,message:"keyName of collection could not change."})}static get collectionQueryNotValid(){return new r({code:n.COLLECTION_QUERY_NOT_VALID,message:"Query parameter is not a valid format."})}static get collectionInsertDuplicate(){return new r({code:n.COLLECTION_INSERT_DUPLICATE,message:"The key already exists."})}static get collectionKeyNotFound(){return new r({code:n.COLLECTION_KEY_NOT_FOUND,message:"The key is not found."})}static get collectionKeyNotGiven(){return new r({code:n.COLLECTION_KEY_NOT_GIVEN,message:"The item should contain [keyName] property."})}static get collectionWriteFailed(){return new r({code:n.COLLECTION_WRITE_FAILED,message:"Failed to write an item."})}static get collectionItemSizeExceeded(){return new r({code:n.COLLECTION_ITEM_SIZE_LIMIT_EXCEEDED,message:"The size of the item exceeds the limit that a collection allows."})}static get indexTableIsRequired(){return new r({code:n.INDEX_TABLE_IS_REQUIRED,message:"Index table is required."})}static get indexTypesNotMatch(){return new r({code:n.INDEX_TYPE_NOT_MATCH,message:"Indexed column should have primitive type."})}static get compareTypesNotMatch(){return new r({code:n.COMPARE_TYPE_NOT_MATCH,message:"Values to compare have different types."})}static get circularReferenceFound(){return new r({code:n.CIRCULAR_REFERENCE_FOUND,message:"Cannot handle circular referenced object."})}}!function(t){t.INIT="init",t.READY="ready",t.CLOSED="closed"}(o||(o={}));const a=(t,e=new WeakMap)=>{if("object"==typeof t&&null!==t){if(e.has(t))throw r.circularReferenceFound;{e.set(t,!0);let i=null;if(Array.isArray(t))i=t.map((t=>a(t,e)));else if(t instanceof RegExp)i=t;else if(t instanceof Date)i=t;else{i={};for(const s in t)i[s]=a(t[s],e)}return e.delete(t),i}}return t},c=(t,e)=>{if(null==e)return 1;if(null==t)return-1;if(typeof t!=typeof e)throw r.compareTypesNotMatch;let i=0;switch(typeof t){case"boolean":case"number":i=t-e;break;case"string":i=t.localeCompare(e)}return i},l=(t,e)=>{let i=0;for(let e=0;e<t.length;e++)i=t.charCodeAt(e)+(i<<6)+(i<<16)-i;return(i>>>0)%e},h=t=>new Promise((e=>{setTimeout((()=>e()),t)})),d=(t,e)=>{if(!e)return!1;if("function"!=typeof t){for(const i in t)if(["/and","&&"].includes(i)){if(t[i].some((t=>!d(t,e))))return!1}else if(["/or","||"].includes(i)){if(t[i].every((t=>!d(t,e))))return!1}else if("/where"===i){if(!(0,t[i])(e))return!1}else{const s=i;if("object"==typeof t[s]){const i=t[s];for(const t in i)switch(t){case"/eq":case"=":if(e[s]!==i[t])return!1;break;case"/neq":case"!=":if(e[s]===i[t])return!1;break;case"/gt":case">":{const n=e[s],o=i[t];if(!(c(n,o)>0))return!1;break}case"/gte":case">=":{const n=e[s],o=i[t];if(!(c(n,o)>=0))return!1;break}case"/lt":case"<":{const n=e[s],o=i[t];if(!(c(n,o)<0))return!1;break}case"/lte":case"<=":{const n=e[s],o=i[t];if(!(c(n,o)<=0))return!1;break}case"/in":{const n=e[s];if(!i[t].includes(n))return!1;break}case"/nin":{const n=e[s];if(i[t].includes(n))return!1;break}case"/contain":{const n=e[s],o=i[t];if(!n.includes(o))return!1;break}case"/regex":{const n=e[s];if(!i[t].test(n))return!1;break}case"/where":{const n=e[s];if(!(0,i[t])(n))return!1;break}}}else if("function"==typeof t[s]){if(!t[s](e[s]))return!1}else if(t[s]!==e[s])return!1}return!0}return t(e)},u=()=>{},_=()=>Promise.resolve(),m=t=>t,y=(t,e)=>{e(null)};var f;!function(t){t[t.FORWARD=0]="FORWARD",t[t.BACKWARD=1]="BACKWARD"}(f||(f={}));class g{constructor({initialPrevValue:t=null,initialNextValue:e=null,iterator:i,map:s=m,backward:n=_,forward:o=_,complete:r=u}){this._prevValue=t,this._nextValue=e,this._error=null,this._map=s,this._backward=n,this._forward=o,this._iterator=i,this._complete=r}get prevValue(){return this._map(this._prevValue)}get nextValue(){return this._map(this._nextValue)}get error(){return this._error}get hasPrevious(){return!!this._prevValue}get hasNext(){return!!this._nextValue}prev(){return t(this,void 0,void 0,(function*(){if(this.hasPrevious){try{const t=this._prevValue;this._prevValue=(yield this._backward())||null,this._nextValue=t}catch(t){this._error=t}return yield this._iterator(this)}this._complete()}))}next(){return t(this,void 0,void 0,(function*(){if(this.hasNext){try{const t=this._nextValue;this._nextValue=(yield this._forward())||null,this._prevValue=t}catch(t){this._error=t}return yield this._iterator(this)}this._complete()}))}stop(){this._prevValue=null,this._nextValue=null,this._complete()}}class v{constructor({condition:t={},backward:e=!1,blockManager:i,indexer:s}){this.condition=t,this.backward=e,this._blockManager=i,this._indexer=s}findOptimizedStartPosition(){const t=["=","/eq",">",">=","/gt","/gte"],e=["=","/eq","<","<=","/lt","/lte"];if(this.backward){let i=this._indexer.origin.length-1;if("function"!=typeof this.condition)for(const s in this._indexer.fields){let n=this._indexer.fields[s],o=1;if("-"===n[0]&&(n=n.slice(1),o=-1),this.condition[n])if("object"==typeof this.condition[n]){const r=o>0?e:t;for(const t in this.condition[n])if(r.includes(t))for(let e=i;e>=0;e--)if(o*c(this._indexer.origin[e].columnValues[s],this.condition[n][t])<=0){i=e;break}}else for(let t=i;t>=0;t--)if(o*c(this._indexer.origin[t].columnValues[s],this.condition[n])<=0){i=t;break}}return Math.min(i+1,this._indexer.origin.length-1)}{let i=0;if("function"!=typeof this.condition)for(let s=0;s<this._indexer.fields.length;s++){let n=this._indexer.fields[s],o=1;if("-"===n[0]&&(n=n.slice(1),o=-1),this.condition[n])if("object"==typeof this.condition[n])Object.keys(this.condition[n]).forEach((r=>{if((o>0?t:e).includes(r))for(let t=i;t<this._indexer.origin.length;t++)if(o*c(this._indexer.origin[t].columnValues[s],this.condition[n][r])>=0){i=t;break}}));else for(let t=i;t<this._indexer.origin.length;t++)if(o*c(this._indexer.origin[t].columnValues[s],this.condition[n])>=0){i=t;break}}return Math.max(i-1,0)}}each(e){return t(this,void 0,void 0,(function*(){let i=this.findOptimizedStartPosition(),s=0;this.backward&&this._indexer.origin[i]&&(s=this._indexer.origin[i].keys.length-1);const n=()=>{if(this._indexer.origin[i]){if(!this._indexer.origin[i].keys[++s]){if(!this._indexer.origin[++i])return!1;s=0}return!0}return!1},o=()=>{if(this._indexer.origin[i]){if(!this._indexer.origin[i].keys[--s]){if(!this._indexer.origin[--i])return!1;s=this._indexer.origin[i].keys.length-1}return!0}return!1};let r=null;if(this._indexer.origin[i]){const t=this.backward?o:n;do{const t=yield this._blockManager.getFromBlock(this._indexer.origin[i].keys[s]);if(d(this.condition,t)){r=t;break}}while(t())}return yield new Promise((c=>{const l=new g({initialNextValue:a(r),iterator:e,forward:()=>t(this,void 0,void 0,(function*(){const t=this.backward?o:n;for(;t();){const t=yield this._blockManager.getFromBlock(this._indexer.origin[i].keys[s]);if(d(this.condition,t))return a(t)}return null})),backward:()=>t(this,void 0,void 0,(function*(){const t=this.backward?n:o;for(;t();){const t=yield this._blockManager.getFromBlock(this._indexer.origin[i].keys[s]);if(d(this.condition,t))return a(t)}return null})),complete:c});e(l)}))}))}}class E{constructor({condition:t={},backward:e=!1,mutex:i,blockManager:s,indexer:n}){this._mutex=i,this._iterator=new v({condition:t,backward:e,blockManager:s,indexer:n})}fetch(e={}){return t(this,void 0,void 0,(function*(){let i=Math.max(e.offset||0,0);const s="number"==typeof e.limit?e.limit:Number.MAX_SAFE_INTEGER;if(0===s)return[];if(s<0)throw r.collectionQueryNotValid;try{const e=[];return yield this._mutex.lock(),yield this._iterator.each((n=>t(this,void 0,void 0,(function*(){n.error?n.stop():n.hasNext?0===i?(e.push(n.nextValue),0<s&&s<=e.length?n.stop():n.next()):(i--,n.next()):n.stop()})))),this._mutex.unlock(),e}catch(t){throw this._mutex.unlock(),t}}))}count(){return t(this,void 0,void 0,(function*(){try{let e=0;return yield this._mutex.lock(),yield this._iterator.each((i=>t(this,void 0,void 0,(function*(){i.error?i.stop():i.hasNext?(e++,i.next()):i.stop()})))),this._mutex.unlock(),e}catch(t){throw this._mutex.unlock(),t}}))}}const N=t=>`nest@${t}`,b=(t,e)=>`${N(t)}/${e}`,k=(t,e)=>`${b(t,e)}.metadata`,p=(t,e)=>`${b(t,e)}/block.`,I=(t,e)=>`${b(t,e)}/blob.`,O=(t,e,i,s=0)=>`${I(t,e)}${i}.${s}`;class T{constructor({dbname:t,collectionName:e,store:i}){this.dbname=t,this.collectionName=e,this._store=i}_makeShards(t,e){const i=Math.max(this._store.itemSizeLimit-1024,0);if(i>0){const s=`${Math.ceil(t.data.length/i)}.${t.type}.${e}`,n=[];for(let e=0;e<t.data.length;e+=i){const s=t.data.slice(e,e+i);n.push(s)}return{blobId:s,shards:n}}return{blobId:null,shards:null}}_encode(e){return t(this,void 0,void 0,(function*(){return yield new Promise((t=>{const i=new FileReader;i.onload=()=>{t({data:i.result,type:e.type})},i.readAsDataURL(e)}))}))}_decode(e){return t(this,void 0,void 0,(function*(){if("undefined"!=typeof fetch){const t=yield fetch(e.data);return yield t.blob()}{const t=512,i=[],s=atob(e.data.split(",")[1]);for(let e=0;e<s.length;e+=t){const n=s.slice(e,e+t),o=new Array(n.length);for(let t=0;t<n.length;t++)o[t]=n.charCodeAt(t);i.push(new Uint8Array(o))}return new Blob(i,{type:e.type})}}))}get(e){return t(this,void 0,void 0,(function*(){const t=[],[i,s]=e.split("."),n=parseInt(i);if(n>0){for(let i=0;i<n;i++){const s=O(this.dbname,this.collectionName,e,i),n=yield this._store.get(s);if(!n||!n.d)throw r.storeBrokenBlob;t.push(n.d)}return yield this._decode({data:t.join(""),type:s})}return null}))}save(e,i=`${Date.now()}`){return t(this,void 0,void 0,(function*(){const t=[],s=yield this._encode(e),{blobId:n,shards:o}=this._makeShards(s,i);if(n){for(let e=0;e<o.length;e++){const i=O(this.dbname,this.collectionName,n,e);t.push({key:i,value:{d:o[e]},generation:1})}if((yield this._store.setMany(t)).some((t=>t instanceof Error)))throw r.storeWriteFailed;return n}return null}))}remove(e){return t(this,void 0,void 0,(function*(){const t=[],[i]=e.split("."),s=parseInt(i);if(s>0){for(let i=0;i<s;i++)t.push(O(this.dbname,this.collectionName,e,i));yield this._store.removeMany(t)}}))}clear(){return t(this,void 0,void 0,(function*(){const t=I(this.dbname,this.collectionName),e=yield this._store.getAllKeys();for(const i of e)i.startsWith(t);yield this._store.removeMany(e)}))}}var x,w,R;!function(t){t[t.COMMIT=0]="COMMIT",t[t.WRITE=1]="WRITE",t[t.ERROR=2]="ERROR"}(x||(x={})),function(t){t.PENDING="pending",t.PERSISTENT="persistent",t.VOLATILE="volatile"}(w||(w={})),function(t){t[t.NO_CACHE=0]="NO_CACHE",t[t.DEFAULT=1]="DEFAULT",t[t.PERSISTENT=2]="PERSISTENT"}(R||(R={}));const A=[w.PENDING,w.VOLATILE],L={};class S{constructor({dbname:t,limit:e=256}){return L[t]||(this.dbname=t,this._items=[],this._limit=e,L[t]=this),L[t]}static get(t){return L[t]}get items(){return this._items}find(e,i,s=R.DEFAULT){return t(this,void 0,void 0,(function*(){let t=this.get(i);if(t)s===R.PERSISTENT&&(t.state=w.PERSISTENT);else{const n=yield e.get(i);n&&(t={key:i,value:n,generation:1,state:s===R.PERSISTENT?w.PERSISTENT:w.VOLATILE},this.put(t))}return t}))}get(t,e=R.DEFAULT){const i=this._items.map((t=>t.key)).indexOf(t);if(i>-1){const t=this._items[i];return e===R.PERSISTENT&&(t.state=w.PERSISTENT),e!==R.NO_CACHE&&this.put(t),t}return null}put(t){if(this._limit>0){const e=this._items.map((t=>t.key)).indexOf(t.key);if(e>-1)A.includes(this._items[e].state)&&A.includes(t.state)?(this._items.splice(e,1),this._items.push(t)):(this._items[e].state=t.state,this._items[e].generation=t.generation,this._items[e].value=t.value);else{this._items.push(t);const e=this._items.filter((t=>t.state===w.VOLATILE));let i=e.length-this._limit;if(i>0){const t=[];for(const e of this._items)e.state===w.VOLATILE&&i>0?i--:t.push(e);this._items=t}}}}remove(t){const e=this._items.map((t=>t.key)).indexOf(t);e>-1&&this._items.splice(e,1)}clearByCondition(t){this._items=this._items.filter((e=>!t(e)))}clear(t=!1){this._items=t?[]:this._items.filter((t=>t.state!==w.VOLATILE))}}class C{constructor({dbname:t,collectionName:e,store:i}){this._metadata=null,this._requests=[],this._onCommit=new Map,this._onWrite=new Map,this._onError=new Map,this.dbname=t,this.collectionName=e,this.metadataKey=((t,e)=>`${b(t,e)}/trans.metadata`)(t,e),this.recordsetKey=((t,e)=>`${b(t,e)}/trans.recordset`)(t,e),this._store=i}get generation(){return this._metadata?this._metadata.generation:0}get requestCount(){return this._requests.length}_getReducedRecordset(e=[]){return t(this,void 0,void 0,(function*(){const t=(yield this._store.get(this.recordsetKey))||[];return t.push(...e),this._reduceRecordSet(t)}))}_reduceRecordSet(t){const e=[],i={};for(let s=t.length-1;s>=0;s--){const n=t[s],o=[];for(let t=n.requests.length-1;t>=0;t--){const e=n.requests[t],s=e.data;i[s.key]||(o.unshift(e),i[s.key]=!0)}o.length>0&&(n.requests=o,e.unshift(n))}return e}_applyRecord(e,i){return t(this,void 0,void 0,(function*(){const t=S.get(this.dbname),{generation:s,requests:n}=i;let o=null;try{const e=yield this._store.setMany(n.map((t=>Object.assign(Object.assign({},t.data),{generation:s}))));for(let i=0;i<n.length;i++)if(e[i]instanceof Error){o||(o=e[i]);const{data:r}=n[i];t.put(Object.assign(Object.assign({},r),{generation:s,state:w.PERSISTENT}))}}catch(t){o=t}if(o)this._onError.forEach((t=>t(o)));else{const t=e.filter((t=>t.generation!==s));yield this._store.set({key:this.recordsetKey,value:t,generation:s}),this._onWrite.forEach((t=>{t(n.map((t=>t.data)))}))}}))}init(){return t(this,void 0,void 0,(function*(){this._metadata=(yield this._store.get(this.metadataKey))||{generation:1};const t=yield this._getReducedRecordset();for(const e of t)yield this._applyRecord(t,e)}))}on(t,e,i){switch(t){case x.COMMIT:this._onCommit.set(e,i);break;case x.WRITE:this._onWrite.set(e,i);break;case x.ERROR:this._onError.set(e,i)}}requestWrite(t,e=null){this._requests.push({data:t,options:e});S.get(this.dbname).put(Object.assign({state:w.PENDING,generation:this.generation},t))}requestMultipleWrite(t,e=null){const i=S.get(this.dbname);for(const s of t)this._requests.push({data:s,options:e}),i.put(Object.assign({state:w.PENDING,generation:this.generation},s))}clear(){return t(this,void 0,void 0,(function*(){S.get(this.dbname).clearByCondition((t=>t.state===w.PENDING)),this._requests=[]}))}commit(){return t(this,void 0,void 0,(function*(){const t=this._requests;if(t.length>0){const e=[],i={};for(let s=t.length-1;s>=0;s--){const n=t[s],o=n.data;i[o.key]||(i[o.key]=!0,e.unshift(n))}const n={generation:this.generation,requests:e},o=yield this._getReducedRecordset([n]);yield this._store.set({key:this.recordsetKey,value:o,generation:this.generation}),this._metadata.generation++,yield this._store.set({key:this.metadataKey,value:this._metadata,generation:1});const r=S.get(this.dbname);for(let t=0;t<e.length;t++){const{data:i,options:s}=e[t];r.put(Object.assign(Object.assign({},i),{generation:n.generation,state:s&&s.persistent?w.PERSISTENT:w.VOLATILE}))}this._requests=[],this._onCommit.forEach((e=>{e(t.map((t=>t.data)))}));const a=s.get(this.dbname);setTimeout((()=>{try{this._applyRecord(o,n)}catch(t){this._onError.forEach((e=>e(t)))}}),a.transactionApplyDelay)}}))}}class D{constructor({blockId:t,keyName:e,items:i=[],limit:s}){this.blockId=t,this.keyName=e,this.limit=s,this._items=[...i]}static createFromCacheItem(t){return t?new D(t.value):null}get isEmpty(){return 0===this._items.length}get items(){return this._items}serialize(){return{blockId:this.blockId,keyName:this.keyName,limit:this.limit,items:this._items}}getItemByKey(t){return this._items.find((e=>{const i=e[this.keyName];return t===i}))}has(t){return this._items.map((t=>t[this.keyName])).includes(t)}add(t){const e=this._items.map((t=>t[this.keyName])).indexOf(t[this.keyName]);return e<0?this._items.length<this.limit&&(this._items.push(t),!0):(this._items[e]=t,!0)}remove(t){for(const e in this._items)if(this._items[e][this.keyName]===t)return this._items.splice(parseInt(e),1),!0;return!1}clear(){this._items=[]}}class B{constructor({dbname:t,collectionName:e,metadata:i,hashFunction:s=l,transaction:n,store:o}){this.dbname=t,this.collectionName=e,this.hashFunction=s,this.metadata=i,this._transaction=n,this._store=o}get keyName(){return this.metadata.keyName}createBlockId(t,e=this.metadata.blockLevel){return i=this.dbname,s=this.collectionName,n=e,o=`${((t,e,i)=>{const s=i.base*Math.pow(i.multiplier,e)+i.constant;return(i.hashFunction||l)(t,s)})(t,e,{hashFunction:this.hashFunction,base:this.metadata.blockHashBase,multiplier:this.metadata.blockHashMultiplier,constant:this.metadata.blockHashConstant})}`,`${p(i,s)}${n}.${o}`;var i,s,n,o}_findBlock(e){return t(this,void 0,void 0,(function*(){const t=S.get(this.dbname);for(let i=this.metadata.blockLevel;i>0;i--){const s=this.createBlockId(e,i),n=yield t.find(this._store,s);if(n){const t=D.createFromCacheItem(n);if(t.getItemByKey(e))return t}}return null}))}getFromBlock(e){return t(this,void 0,void 0,(function*(){const t=yield this._findBlock(e);return t?t.getItemByKey(e):null}))}putToBlock(e,i){return t(this,void 0,void 0,(function*(){const t=s.get(this.dbname),n=this.createBlockId(e),o=Math.floor(this._store.itemSizeLimit/t.itemSizeLimit),r=S.get(this.dbname),a=yield r.find(this._store,n),c=a?D.createFromCacheItem(a):new D({blockId:n,keyName:this.keyName,items:[],limit:o});return!!c.add(i)&&(this._transaction.requestWrite({key:c.blockId,value:c.serialize()}),!0)}))}removeFromBlock(e){return t(this,void 0,void 0,(function*(){const t=yield this._findBlock(e);return!(!t||!t.remove(e))&&(this._transaction.requestWrite({key:t.blockId,value:t.serialize()}),!0)}))}clearAllBlocks(){return t(this,void 0,void 0,(function*(){const t=p(this.dbname,this.collectionName),e=(yield this._store.getAllKeys()).filter((e=>e.startsWith(t)));yield this._store.removeMany(e);const i=S.get(this.dbname);for(const t of e)i.remove(t)}))}}const M=t=>{const e=typeof t;return null===t||"undefined"===e||"boolean"===e||"number"===e||"string"===e};class P{constructor({dbname:t,collectionName:e,keyName:i,fields:s,transaction:n,store:o}){this._origin=[],this._table=[],this.dbname=t,this.collectionName=e,this.keyName=i,this.fields=s,this.indexerKey=((t,e,i)=>`${b(t,e)}/index.${i}`)(this.dbname,this.collectionName,this.fields.join(">")),this._transaction=n,this._store=o,this._transaction.on(x.COMMIT,this.indexerKey,(()=>this.commit())),this._transaction.on(x.ERROR,this.indexerKey,(()=>this.abort()))}static createKey(t){return t.join(">")}static parseKey(t){return t.split(">")}_addItem(t){const e=t[this.keyName],i=this.getColumnValues(t),[s,n]=this.indexOf(i);return n?!this._table[s].keys.includes(e)&&(this._table[s].keys.push(e),!0):(this._table.splice(s,0,{columnValues:i,keys:[e]}),!0)}_removeItem(t){const e=t[this.keyName],i=this.getColumnValues(t),[s,n]=this.indexOf(i);if(n){const t=this._table[s].keys.indexOf(e);if(t>-1)return this._table[s].keys.splice(t,1),0===this._table[s].keys.length&&this._table.splice(s,1),!0}return!1}get origin(){return this._origin}get table(){return this._table}getColumnValues(t){const e=[];for(let i of this.fields){if("-"===i[0]&&(i=i.slice(1)),!M(t[i]))throw r.indexTypesNotMatch;e.push(t[i])}return e}diff(t,e){for(const i in this.fields){const s="-"===this.fields[i][0]?-1:1,n=c(t[i],e[i]);if(0!==n)return s*n}return 0}indexOf(t){if(this._table.length>0){let e=0,i=this._table.length-1;for(;e<=i;){const s=Math.floor((e+i)/2),n=this.diff(t,this._table[s].columnValues);if(n>0)e=s+1;else{if(!(n<0))return[s,!0];i=s-1}}return[e,!1]}return[0,!1]}ensure(){return t(this,void 0,void 0,(function*(){const t=S.get(this.dbname),e=yield t.find(this._store,this.indexerKey,R.PERSISTENT);if(e)this._origin=e.value,this._table=a(this._origin);else{const e=p(this.dbname,this.collectionName),i=yield this._store.getAllKeys();for(const s of i)if(s.startsWith(e)){const e=yield t.find(this._store,s,R.NO_CACHE),i=D.createFromCacheItem(e);for(const t of i.items)this._addItem(t)}this._transaction.requestWrite({key:this.indexerKey,value:this._table},{persistent:!0})}}))}drop(){return t(this,void 0,void 0,(function*(){S.get(this.dbname).remove(this.indexerKey),yield this._store.remove(this.indexerKey)}))}addItem(e){return t(this,void 0,void 0,(function*(){this._addItem(e)&&this._transaction.requestWrite({key:this.indexerKey,value:this._table},{persistent:!0})}))}removeItem(e){return t(this,void 0,void 0,(function*(){this._removeItem(e)&&this._transaction.requestWrite({key:this.indexerKey,value:this._table},{persistent:!0})}))}clear(){return t(this,void 0,void 0,(function*(){this._table=[],this._transaction.requestWrite({key:this.indexerKey,value:this._table},{persistent:!0})}))}commit(){this._origin=this._table,this._table=a(this._origin)}abort(){this._table=a(this._origin)}}class K{constructor(t){this._locked=!1,this._resolvers=[],this.id=(()=>{let t=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?i:3&i|8).toString(16)}))})(),this.key=t}get locked(){return this._locked}wait(){return new Promise((t=>{this._resolvers.push(t)}))}lock(){return t(this,void 0,void 0,(function*(){this._locked&&(yield this.wait()),this._locked=!0}))}unlock(){if(this._locked)if(this._resolvers.length>0){this._resolvers.shift()()}else this._locked=!1}}class F{constructor({dbname:t,collectionName:e,keyName:i,keyHash:s,indexes:n,store:r}){this._state=o.INIT,this._metadata=null,this._indexers=[],this.dbname=t,this.name=e,this.keyName=i,this.indexes=[[i],...n.filter((t=>P.createKey(t)!==this.keyName))],this._keyHash=s,this._store=r,this._mutex=new K(((t,e)=>`${b(t,e)}.lock`)(t,e)),this._blobContainer=new T({dbname:t,collectionName:e,store:r}),this._transaction=new C({dbname:t,collectionName:e,store:r})}static metadataOf(e,i,s){return t(this,void 0,void 0,(function*(){const t=k(e,i);return yield s.get(t)}))}get state(){return this._state}init(){return t(this,void 0,void 0,(function*(){yield this._mutex.lock();try{const t=s.get(this.dbname),e=yield F.metadataOf(this.dbname,this.name,this._store);this._metadata=e||{keyName:this.keyName,blockLevel:1,blockHashBase:t.blockHashBase,blockHashMultiplier:t.blockHashMultiplier,blockHashConstant:t.blockHashConstant,indexes:this.indexes},yield this._transaction.init(),this._blockManager=new B({dbname:this.dbname,collectionName:this.name,hashFunction:this._keyHash,metadata:this._metadata,transaction:this._transaction,store:this._store});const i=[...this.indexes],n=[],r=i.map((t=>P.createKey(t))),a=e?e.indexes.map((t=>P.createKey(t))):[];for(const t of a)r.includes(t)||n.push(P.parseKey(t));const c=[];if(c.push(...i.map((t=>{const e=new P({dbname:this.dbname,collectionName:this.name,keyName:this.keyName,fields:t,transaction:this._transaction,store:this._store});return this._indexers.push(e),e.ensure()}))),c.push(...n.map((t=>new P({dbname:this.dbname,collectionName:this.name,keyName:this.keyName,fields:t,transaction:this._transaction,store:this._store}).drop()))),yield Promise.all(c),yield this._transaction.commit(),r.sort().join(",")!==a.sort().join(",")){const t=k(this.dbname,this.name);this._metadata.indexes=i,yield this._store.set({key:t,value:this._metadata,generation:1})}this._state=o.READY,this._mutex.unlock()}catch(t){throw this._mutex.unlock(),t}}))}close(){this._state=o.CLOSED}_hasPropertyOfKeyName(t){const e=t[this.keyName];return"string"==typeof e&&!!e}_getIndexerBy(t=null){t||(t=[this.keyName]);const e=P.createKey(t);for(const t of this._indexers)if(e===P.createKey(t.fields))return t;return null}_upgradeBlockLevel(){return t(this,void 0,void 0,(function*(){const t=k(this.dbname,this.name);this._metadata.blockLevel++,yield this._store.set({key:t,value:this._metadata,generation:1})}))}_requestInsert(e){return t(this,void 0,void 0,(function*(){const t=e[this.keyName];if(yield this._blockManager.getFromBlock(t))throw r.collectionInsertDuplicate;(yield this._blockManager.putToBlock(t,e))||(yield this._upgradeBlockLevel(),yield this._blockManager.putToBlock(t,e));for(const t of this._indexers)yield t.addItem(e)}))}_requestUpsert(e){return t(this,void 0,void 0,(function*(){const t=e[this.keyName],i=yield this._blockManager.getFromBlock(t);if(i){yield this._blockManager.putToBlock(t,e);for(const t of this._indexers)0!==t.diff(t.getColumnValues(i),t.getColumnValues(e))&&(yield t.removeItem(i),yield t.addItem(e))}else{(yield this._blockManager.putToBlock(t,e))||(yield this._upgradeBlockLevel(),yield this._blockManager.putToBlock(t,e));for(const t of this._indexers)yield t.addItem(e)}}))}_requestUpdate(e){return t(this,void 0,void 0,(function*(){const t=e[this.keyName],i=yield this._blockManager.getFromBlock(t);if(i){yield this._blockManager.putToBlock(t,e);for(const t of this._indexers)0!==t.diff(t.getColumnValues(i),t.getColumnValues(e))&&(yield t.removeItem(i),yield t.addItem(e))}}))}_requestRemove(e){return t(this,void 0,void 0,(function*(){const t=yield this._blockManager.getFromBlock(e);if(t){yield this._blockManager.removeFromBlock(e);for(const e of this._indexers)yield e.removeItem(t)}}))}_requestClear(){return t(this,void 0,void 0,(function*(){yield this._blockManager.clearAllBlocks();for(const t of this._indexers)yield t.clear()}))}getByKey(e){return t(this,void 0,void 0,(function*(){if(this._state!==o.READY)throw r.collectionNotReady;yield this._mutex.lock();try{const t=yield this._blockManager.getFromBlock(e);return this._mutex.unlock(),a(t)}catch(t){throw this._mutex.unlock(),t}}))}query(t={}){return this._state===o.READY?new E({condition:t.where,mutex:this._mutex,blockManager:this._blockManager,indexer:this._getIndexerBy(t.index),backward:!!t.backward}):null}insertOne(e){return t(this,void 0,void 0,(function*(){if(this._state!==o.READY)throw r.collectionNotReady;yield this._mutex.lock();try{if(!this._hasPropertyOfKeyName(e))throw r.collectionKeyNotGiven;return yield this._requestInsert(a(e)),yield this._transaction.commit(),this._mutex.unlock(),e}catch(t){throw yield this._transaction.clear(),this._mutex.unlock(),t}}))}insertMany(e){return t(this,void 0,void 0,(function*(){if(this._state!==o.READY)throw r.collectionNotReady;yield this._mutex.lock();try{if(e.some((t=>!this._hasPropertyOfKeyName(t))))throw r.collectionKeyNotGiven;for(const t of e)yield this._requestInsert(a(t));return yield this._transaction.commit(),this._mutex.unlock(),e}catch(t){throw yield this._transaction.clear(),this._mutex.unlock(),t}}))}upsertOne(e){return t(this,void 0,void 0,(function*(){if(this._state!==o.READY)throw r.collectionNotReady;yield this._mutex.lock();try{if(!this._hasPropertyOfKeyName(e))throw r.collectionKeyNotGiven;return yield this._requestUpsert(a(e)),yield this._transaction.commit(),this._mutex.unlock(),e}catch(t){throw yield this._transaction.clear(),this._mutex.unlock(),t}}))}upsertMany(e){return t(this,void 0,void 0,(function*(){if(this._state!==o.READY)throw r.collectionNotReady;yield this._mutex.lock();try{if(e.some((t=>!this._hasPropertyOfKeyName(t))))throw r.collectionKeyNotGiven;for(const t of e)yield this._requestUpsert(a(t));return yield this._transaction.commit(),this._mutex.unlock(),e}catch(t){throw yield this._transaction.clear(),this._mutex.unlock(),t}}))}update(e){return t(this,void 0,void 0,(function*(){if(this._state!==o.READY)throw r.collectionNotReady;yield this._mutex.lock();try{if(!this._hasPropertyOfKeyName(e))throw r.collectionKeyNotGiven;return yield this._requestUpdate(a(e)),yield this._transaction.commit(),this._mutex.unlock(),e}catch(t){throw yield this._transaction.clear(),this._mutex.unlock(),t}}))}updateIf(e,i){return t(this,void 0,void 0,(function*(){if(this._state!==o.READY)throw this._transaction.clear(),r.collectionNotReady;yield this._mutex.lock();try{const s=[],n=new v({condition:e,blockManager:this._blockManager,indexer:this._getIndexerBy(null)});yield n.each((n=>t(this,void 0,void 0,(function*(){if(n.error)throw n.stop(),n.error;if(n.hasNext){const t=n.nextValue;if(d(e,t)&&i.set){if("function"!=typeof i.set)for(const e in i.set)t[e]=i.set[e];else i.set(t);s.push(t)}n.next()}else n.stop()}))));for(const t of s)yield this._requestUpdate(a(t));return yield this._transaction.commit(),this._mutex.unlock(),s}catch(t){throw yield this._transaction.clear(),this._mutex.unlock(),t}}))}remove(e){return t(this,void 0,void 0,(function*(){if(this._state!==o.READY)throw r.collectionNotReady;yield this._mutex.lock();try{yield this._requestRemove(e),yield this._transaction.commit(),this._mutex.unlock()}catch(t){throw yield this._transaction.clear(),this._mutex.unlock(),t}}))}removeIf(e){return t(this,void 0,void 0,(function*(){if(this._state!==o.READY)throw this._transaction.clear(),r.collectionNotReady;yield this._mutex.lock();try{const i=[],s=new v({condition:e,blockManager:this._blockManager,indexer:this._getIndexerBy(null)});yield s.each((s=>t(this,void 0,void 0,(function*(){if(s.error)throw s.stop(),s.error;if(s.hasNext){const t=s.nextValue;if(d(e,t)){const e=t[this.keyName];i.push(e)}s.next()}else s.stop()}))));for(const t of i)yield this._requestRemove(t);return yield this._transaction.commit(),this._mutex.unlock(),i}catch(t){throw this._mutex.unlock(),t}}))}clear(){return t(this,void 0,void 0,(function*(){if(this._state!==o.READY)throw r.collectionNotReady;yield this._mutex.lock();try{yield this._requestClear(),yield this._transaction.commit(),this._mutex.unlock()}catch(t){throw yield this._transaction.clear(),this._mutex.unlock(),t}}))}getBlob(e){return t(this,void 0,void 0,(function*(){return yield this._blobContainer.get(e)}))}saveBlob(e,i=null){return t(this,void 0,void 0,(function*(){return yield this._blobContainer.save(e,i)}))}removeBlob(e){return t(this,void 0,void 0,(function*(){yield this._blobContainer.remove(e)}))}removeAllBlobs(){return t(this,void 0,void 0,(function*(){yield this._blobContainer.clear()}))}}const V=4194304,W=1,Y={};class q{constructor(t={}){const{itemSizeLimit:i=V,delay:s=W,encryption:n=e}=t;this._encryption=n,this.itemSizeLimit=i,this.delay=s,this.observer={}}get rawData(){return Y[this.dbname]}set rawData(t){Y[this.dbname]=t}observe(t,e,i){this.observer[t]={},e.forEach((e=>this.observer[t][e]=i))}init(e){return t(this,void 0,void 0,(function*(){this.dbname=e,Y[this.dbname]={}}))}getAllKeys(){return t(this,void 0,void 0,(function*(){return Object.keys(Y[this.dbname])}))}get(e){return t(this,void 0,void 0,(function*(){yield h(this.delay);const t=this.observer[e],i=t&&t.get?t.get(e):null;if(i)throw i;return Y[this.dbname][e]?this._encryption.decrypt(Y[this.dbname][e]):null}))}set(e){return t(this,void 0,void 0,(function*(){yield h(this.delay);const{key:t,value:i}=e,s=this.observer[t],n=s&&s.set?s.set(t):null;if(n)throw n;const o=this._encryption.encrypt(i);if(JSON.stringify(o).length<this.itemSizeLimit)return Y[this.dbname][t]=o,Y[this.dbname][t];throw r.storeItemSizeExceeded}))}setMany(e){return t(this,void 0,void 0,(function*(){yield h(this.delay);const t=[];return e.forEach((e=>{const{key:i,value:s}=e,n=this.observer[i];if(n&&n.set?n.set(i):null)t.push(r.collectionWriteFailed);else{const e=this._encryption.encrypt(s);JSON.stringify(e).length<this.itemSizeLimit?(Y[this.dbname][i]=e,t.push(s)):t.push(r.storeItemSizeExceeded)}})),t}))}remove(e){return t(this,void 0,void 0,(function*(){yield h(this.delay);const t=this.observer[e],i=t&&t.remove?t.remove(e):null;if(i)throw i;return Y[this.dbname][e]&&delete Y[this.dbname][e],e}))}removeMany(e){return t(this,void 0,void 0,(function*(){yield h(this.delay);for(const t of e){const e=this.observer[t],i=e&&e.remove?e.remove(t):null;if(i)throw i;Y[this.dbname][t]&&delete Y[this.dbname][t]}return e}))}clear(){return t(this,void 0,void 0,(function*(){yield h(this.delay),Y[this.dbname]={}}))}}const U="undefined"!=typeof document&&"undefined"!=typeof navigator;U&&navigator.userAgent&&navigator.userAgent.includes("Chrome/")&&navigator.userAgent.includes("Chromium/");const H=U&&navigator.userAgent&&navigator.userAgent.includes("Firefox/")&&!navigator.userAgent.includes("Seamonkey/");U&&navigator.userAgent&&navigator.userAgent.includes("Safari/")&&!navigator.userAgent.includes("Chrome/")&&navigator.userAgent.includes("Chromium/"),U&&navigator.userAgent&&(navigator.userAgent.includes("OPR/")||navigator.userAgent.includes("Opera/")),U&&navigator.userAgent&&navigator.userAgent.includes("Trident/7.0");const G=U&&navigator.userAgent&&navigator.userAgent.includes("Edge/");class j{constructor(t={}){this.itemSizeLimit=104857600;const{encryption:i=e}=t;this._window="undefined"!=typeof window?window:null,this._indexedDB=this._window?this._window.indexedDB||this._window.mozIndexedDB||this._window.webkitIndexedDB||this._window.msIndexedDB:null,this._encryption=i}init(e){return t(this,void 0,void 0,(function*(){this.dbname=e;const t=new Promise(((t,e)=>{if(this._window&&U)if(H){const i=this._indexedDB.open("_testMozilla");i.onerror=()=>e(r.storeNotAvailableInPrivateBrowsing),i.onsuccess=()=>t()}else G?this._window.indexedDB||!this._window.PointerEvent&&!this._window.MSPointerEvent||e(r.storeNotAvailableInPrivateBrowsing):t();else e(r.storeNotAvailable)}));yield t,this._database=yield new Promise(((t,i)=>{const s=this._indexedDB.open(e);s.addEventListener("upgradeneeded",(t=>{t.target.result.createObjectStore("NestDBStore",{keyPath:"key"})})),s.addEventListener("success",(e=>t(e.target.result))),s.addEventListener("error",(t=>i(t.target.error)))}))}))}getAllKeys(){return t(this,void 0,void 0,(function*(){return yield new Promise(((t,e)=>{const i=this._database.transaction("NestDBStore","readonly").objectStore("NestDBStore").getAllKeys();i.addEventListener("success",(e=>t(e.target.result))),i.addEventListener("error",(t=>e(t.target.error)))}))}))}get(e){return t(this,void 0,void 0,(function*(){return yield new Promise(((t,i)=>{const s=this._database.transaction("NestDBStore","readonly").objectStore("NestDBStore").get(e);s.addEventListener("success",(e=>t(e.target.result?this._encryption.decrypt(e.target.result.value):null))),s.addEventListener("error",(t=>i(t.target.error)))}))}))}set(e){return t(this,void 0,void 0,(function*(){const{key:t,value:i}=e;return yield new Promise(((e,s)=>{const n=this._database.transaction("NestDBStore","readwrite").objectStore("NestDBStore").put({key:t,value:this._encryption.encrypt(i)});n.addEventListener("success",(t=>{e(t.target.result)})),n.addEventListener("error",(t=>s(t.target.error)))})),i}))}setMany(e){return t(this,void 0,void 0,(function*(){const t=[],i=this._database.transaction("NestDBStore","readwrite").objectStore("NestDBStore");return e.forEach((e=>{const{key:s,value:n}=e;t.push(new Promise((t=>{const e=i.put({key:s,value:this._encryption.encrypt(n)});e.addEventListener("success",(e=>{t(e.target.result)})),e.addEventListener("error",(()=>{t(r.collectionWriteFailed)}))})))})),yield Promise.all(t),e.map((t=>t.value))}))}remove(e){return t(this,void 0,void 0,(function*(){return yield new Promise(((t,i)=>{const s=this._database.transaction("NestDBStore","readwrite").objectStore("NestDBStore").delete(e);s.addEventListener("success",(()=>t(e))),s.addEventListener("error",(t=>i(t.target.error)))}))}))}removeMany(e){return t(this,void 0,void 0,(function*(){const t=this._database.transaction("NestDBStore","readwrite").objectStore("NestDBStore");return yield Promise.all(e.map((e=>new Promise(((i,s)=>{const n=t.delete(e);n.addEventListener("success",(()=>i(e))),n.addEventListener("error",(t=>s(t.target.error)))})))))}))}clear(){return t(this,void 0,void 0,(function*(){return yield new Promise(((t,e)=>{const i=this._database.transaction("NestDBStore","readwrite").objectStore("NestDBStore").clear();i.addEventListener("success",(()=>t())),i.addEventListener("error",(t=>e(t.target.error)))}))}))}}class z{constructor({AsyncStorage:t,encryption:i=e}){this.itemSizeLimit=6291456,this._asyncStorage=t,this._encryption=i}_isBelonging(t){return t.startsWith(`${this.dbname}/`)}_getActualKey(t){return`${this.dbname}/${t}`}init(e){return t(this,void 0,void 0,(function*(){this.dbname=e}))}getAllKeys(){return t(this,void 0,void 0,(function*(){return(yield this._asyncStorage.getAllKeys()).filter((t=>this._isBelonging(t))).map((t=>t.substr(`${this.dbname}/`.length)))}))}get(e){return t(this,void 0,void 0,(function*(){return this._encryption.decrypt(JSON.parse(yield this._asyncStorage.getItem(this._getActualKey(e))))}))}set(e){return t(this,void 0,void 0,(function*(){const{key:t,value:i}=e,s=JSON.stringify(this._encryption.encrypt(i));if(s.length<this.itemSizeLimit)return yield this._asyncStorage.setItem(this._getActualKey(t),s),JSON.parse(s);throw r.storeItemSizeExceeded}))}setMany(e){return t(this,void 0,void 0,(function*(){const t=[];for(const i of e)try{const{key:e,value:s}=i,n=JSON.stringify(this._encryption.encrypt(s));n.length<this.itemSizeLimit?(yield this._asyncStorage.setItem(this._getActualKey(e),n),t.push(s)):t.push(r.storeItemSizeExceeded)}catch(e){t.push(r.collectionWriteFailed)}return t}))}remove(e){return t(this,void 0,void 0,(function*(){return yield this._asyncStorage.removeItem(this._getActualKey(e)),e}))}removeMany(e){return t(this,void 0,void 0,(function*(){for(const t of e)yield this._asyncStorage.removeItem(this._getActualKey(t));return e}))}clear(){return t(this,void 0,void 0,(function*(){const t=yield this.getAllKeys();yield this.removeMany(t)}))}}let $=!0;class X{static off(){$=!1}static log(...t){$&&console.log("[NESTDB][LOG]",...t)}static warning(...t){$&&console.warn("[NESTDB][WARNING]",...t)}static error(...t){$&&console.error("[NESTDB][ERROR]",...t)}}var Q;!function(t){t.INIT="INIT",t.OPENING="OPENING",t.OPENED="OPENED",t.CLOSED="CLOSED"}(Q||(Q={}));class J{constructor({name:t,version:e,store:i,config:n}){this.name=t,this._version=e,this._state=Q.INIT,this._config=n||new s({dbname:t}),this._store=i,this._event={success:u,error:u,upgrade:y},this._collections=new Map,this._globalMutex=new K(`${this.name}.lock`),this._config.disableLogger&&X.off(),new S({dbname:t,limit:this._config.cacheLimit})}get version(){return this._version}get state(){return this._state}commitSchema(e){return t(this,void 0,void 0,(function*(){if(this._state!==Q.OPENING)throw r.databaseSchemaNotOnUpgrade;yield Promise.all(e.map((e=>t(this,void 0,void 0,(function*(){const{collectionName:t,keyName:i,index:s=[]}=e;this._collections.has(t)||this._collections.set(t,new F({dbname:this.name,collectionName:t,keyName:i,keyHash:e.keyHash||null,indexes:s,store:this._store})),yield this._collections.get(t).init()})))))}))}open(){var e;return t(this,void 0,void 0,(function*(){if(yield this._globalMutex.lock(),this._state!==Q.OPENED){this._state=Q.OPENING;try{yield this._store.init(this.name);const s=(i=this.name,`${N(i)}.metadata`),n={version:0,collectionNames:[]},o=null!==(e=yield this._store.get(s))&&void 0!==e?e:n;return new Promise(((e,i)=>{const n=e=>{o.version<this._version?this._event.upgrade(o.version,(i=>t(this,void 0,void 0,(function*(){if(i)e({continued:!1,err:i});else{o.version++,o.collectionNames=Array.from(this._collections.keys());try{yield this._store.set({key:s,value:o,generation:this._version}),e({continued:!0})}catch(t){e({continued:!1,err:t})}}})))):e({continued:!1})},r=s=>{const{continued:a=!1,err:c=null}=s;if(a)setTimeout((()=>n(r)),10);else if(c)X.error(c.message),this._globalMutex.unlock(),this._event.error(c),i(c);else{const s=[];o.collectionNames.forEach((e=>{this._collections.has(e)||s.push((()=>t(this,void 0,void 0,(function*(){const t=yield F.metadataOf(this.name,e,this._store);if(t){const i=new F({dbname:this.name,collectionName:e,keyName:t.keyName,indexes:t.indexes,store:this._store});this._collections.set(e,i),yield i.init()}})))())})),Promise.all(s).then((()=>{this._state=Q.OPENED,this._globalMutex.unlock(),this._event.success(),e()})).catch((t=>{X.error(t.message),this._globalMutex.unlock(),this._event.error(t),i(t)}))}};n(r)}))}catch(t){switch(t.code){case n.STORE_NOT_AVAILABLE_IN_PRIVATE_BROWSING:X.warning("Access to the local storage is not allowed in private browsing. Switched to MemoryStore automatically."),this._store=new q({}),this._globalMutex.unlock(),this._event.error(t),yield this.open();break;case n.STORE_NOT_AVAILABLE:X.warning("IndexedDB is not available in this environment. Switched to MemoryStore automatically. Consider using other store to save data persistently (e.g. AsyncStorage)."),this._store=new q({}),this._globalMutex.unlock(),this._event.error(t),yield this.open();break;default:throw X.error(t.message),this._globalMutex.unlock(),this._event.error(t),t}}}var i}))}close(){this._state=Q.CLOSED,this._collections.forEach((t=>t.close()))}reset(){return t(this,void 0,void 0,(function*(){const t=S.get(this.name);t&&t.clearByCondition((t=>t.key.startsWith(N(this.name)))),yield this._store.clear()}))}on(t,e){this._event[t]=e}off(t){if("function"==typeof this._event[t])if("upgrade"===t)this._event[t]=y;else this._event[t]=u}collection(t){return this._collections.get(t)||null}}export{z as A,e as D,j as I,q as M,Q as N,J as a};
